# Automation & Verification Guide (BlastEm + GDB)

To iterate rapidly and verify regression fixes without manual playtesting, we utilize a **Hybrid GDB Automation Pipeline**. This allows us to strictly control execution, inspect internal state (RAM), and capture visual evidence simultaneously.

## 1. Architecture

- **Emulator**: BlastEm (`blastem.exe`) running in GDB Server Mode (`-D`).
  - Listens on `localhost:1234`.
  - Protocol: GDB Remote Serial Protocol (RSP).
- **Controller**: Python Script (`tools/blastem_remote.py`).
  - Uses `socket` to speak raw RSP (bypassing generic `gdb.exe` quirks).
  - Uses `PIL.ImageGrab` for visual capture.
- **Data Source**: `out/symbol.txt` (via `nm`) mapping C variables to RAM addresses.

## 2. Setup

Ensure the following tools are available:

1. **BlastEm**: `C:\Users\estee\Desktop\blastem-win32-0.6.2\blastem.exe`
2. **GDB Symbols**: Build with `debug` enabled or check `out/symbol.txt`.
3. **Python Libs**: `pip install pillow`

## 3. Memory Address Resolution

To read variables like `game.score` remotely, you must locate their **RAM Address** (0xE0... or 0xFF...).

1. Open `projects/epoch/out/symbol.txt` (Generated by build).
2. Search for the variable name (e.g., `game`, `playerData`).
3. Note the address (First column).

**Example Mapping (v0.2):**

- `game`: `0xE0FF0436`
- `playerData`: `0xE0FF1324` -> `currentHP` is +6 (`0xE0FF132A`)
- `input`: `0xE0FF1338`

*Note: If variables are missing, they may be static/localized. Removing `static` keyword or checking adjacent global addresses helps.*

## 4. The Automation Script (`tools/blastem_remote.py`)

The script follows this sequence:

1. **Launch**: `blastem.exe rom.bin -D` (Starts paused).
2. **Connect**: TCP Socket to `:1234`.
3. **Continue**: Send `$c#63` to let the game boot.
4. **Wait**: `time.sleep(5)` for initialization.
5. **Halt**: Send `\x03` (Ctrl+C) to pause bus.
6. **Read**: Send `$mADDR,LEN#XX` to query RAM.
7. **Capture**: `ImageGrab.grab()` saves the frame.
8. **Verify**: Assert HP == 100.

## 5. Input Injection (Remote Player Control)

To simulate input without `SendKeys`:

1. Locate `input` struct address (`0xE0FF1338`).
2. Overwrite `input.current` (`u16` at offset 0).
3. **Timing**: Write this value repeatedly during the frame loop, or hook `input_update` to read from a Debug Address instead of Hardware.
    - *Implementation Tip*: Create `u16 debugInput` in `main.c`. If `debugInput != 0`, use it. Write to `debugInput` via GDB.

## 6. Visual Model Processing

Pipeline for simple visual AI auditing:

1. Run `tools/blastem_remote.py`.
2. Upload `artifacts/automation_test/automation_capture.png`.
3. Prompt: "Verify this screenshot shows the HUD at the top and the Tower in the center."

## 7. Troubleshooting

- **Connection Reset**: BlastEm crashed or closed socket on Kill.
- **Read 0**: Game was not running or address is wrong. Ensure `$c` was sent.
- **Hang on Interrupt**: Some BlastEm versions ignore `\x03`. Use breakpoints (`$Z0...`) at `main` loop instead.
